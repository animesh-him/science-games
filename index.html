<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Science Experiments Game</title>
<style>
  :root{
    --bg:#f6fbff; --card:#ffffff; --muted:#6a7682; --accent:#1667a6; --success:#15843a; --danger:#c63636;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#062233}
  header{padding:20px;text-align:center}
  header h1{margin:0;font-size:22px}
  header p{margin:6px 0;color:var(--muted);font-size:13px}
  .wrap{max-width:980px;margin:12px auto;padding:12px}
  .tiles{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .tile{padding:12px 16px;border-radius:12px;background:var(--card);box-shadow:0 8px 22px rgba(8,20,40,0.06);cursor:pointer;min-width:128px;text-align:center;font-weight:700;outline:none}
  .tile small{display:block;font-weight:500;color:var(--muted);font-size:12px;margin-top:6px}
  .tile:focus{box-shadow:0 0 0 4px rgba(22,103,166,0.12)}
  .hub{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(8,20,40,0.06);margin-top:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{cursor:pointer;border:1px solid rgba(8,20,40,0.06);background:white;padding:8px 12px;border-radius:8px}
  .small{font-size:13px;color:var(--muted)}
  .status{margin-top:10px;font-size:14px}
  .card{background:#fff;padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 8px 18px rgba(8,20,40,0.04)}
  .question{font-size:18px;font-weight:700;margin-bottom:10px}
  .options{display:flex;flex-direction:column;gap:8px}
  .opt-btn{padding:10px;border-radius:8px;border:1px solid #eaf5ff;background:linear-gradient(#fff,#fbfdff);text-align:left}
  .feedback{margin-top:10px;min-height:28px;font-weight:700}
  .correct{color:var(--success)}
  .wrong{color:var(--danger)}
  .hint{color:#664400;background:#fff8e0;padding:8px;border-radius:8px;margin-top:8px}
  .controls-bottom{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .footer{padding:12px;text-align:center;color:var(--muted);font-size:12px;margin-top:18px}
  @media (max-width:720px){
    .tile{min-width:100px;padding:10px}
    header h1{font-size:18px}
    .question{font-size:16px}
  }
</style>
</head>
<body>
<header>
  <h1>Science Experiments Game</h1>
  <p>One experiment at a time ‚Äî Play or Training mode. Points, stars and printable certificate included.</p>
</header>

<div class="wrap">
  <!-- Age selection -->
  <div id="stage-age">
    <div class="small" style="text-align:center;margin-bottom:8px">Choose an age group</div>
    <div class="tiles" aria-label="Age groups">
      <div class="tile" data-age="5-8" tabindex="0"
           onclick="selectAge('5-8', this)" onkeydown="if(event.key==='Enter'){event.preventDefault();selectAge('5-8',this)}">
        Age 5‚Äì8 <small>Beginner</small>
      </div>
      <div class="tile" data-age="8-14" tabindex="0"
           onclick="selectAge('8-14', this)" onkeydown="if(event.key==='Enter'){event.preventDefault();selectAge('8-14',this)}">
        Age 8‚Äì14 <small>Curious</small>
      </div>
      <div class="tile" data-age="14+" tabindex="0"
           onclick="selectAge('14+', this)" onkeydown="if(event.key==='Enter'){event.preventDefault();selectAge('14+',this)}">
        Age 14+ <small>Advanced</small>
      </div>
    </div>
  </div>

  <!-- Hub -->
  <div id="stage-hub" class="hub" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div>
        <h2 id="hub-title" style="margin:0">Age</h2>
        <div id="progress-display" class="small">Solved 0 / 0</div>
      </div>
      <div>
        <div class="controls">
          <button id="btn-play" onclick="setMode('play')">Play</button>
          <button id="btn-train" onclick="setMode('train')">Training</button>
          <button onclick="backToAge()">Back</button>
        </div>
        <div style="margin-top:8px">
          <button onclick="openPrintableCertificate()">Certificate</button>
        </div>
      </div>
    </div>

    <div class="status small" id="status-bar">Points: <span id="pts">0</span> ‚Ä¢ Stars: <span id="stars">0</span></div>

    <!-- Single experiment card -->
    <div id="experiment-card" class="card" style="display:none">
      <div class="question" id="question-text">Question text</div>
      <div class="options" id="options-box"></div>
      <div class="feedback" id="feedback"></div>

      <div class="controls-bottom">
        <button onclick="repeatVoice()">üîÅ Repeat</button>
        <button onclick="showHint()">üí° Hint</button>
        <button id="next-btn" style="display:none" onclick="nextExperiment()">‚û° Next</button>
      </div>
    </div>

    <div id="finished-card" class="card" style="display:none">
      <div style="font-weight:700">You finished this level ‚Äî well done!</div>
      <div class="small" style="margin-top:8px">Generate a certificate or restart the level.</div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button onclick="restartLevel()">Restart</button>
        <button onclick="backToAge()">Back to Age selection</button>
      </div>
    </div>
  </div>
</div>

<div class="footer">Created &amp; Designed by Animesh</div>

<script>
/* =========================
   Experiments data (20 each)
   ========================= */
const EXPERIMENTS = {
  "5-8": [
    {"prompt":"Which object will float on water?","options":["Rock","Piece of wood","Coin"],"answer":1,"hint":"Light and less dense than water","explanation":"Wood floats because it is less dense than water.","voice":"Which object will float on water?"},
    {"prompt":"Which pipe will fill the bucket? (Left or Right)","options":["Left path","Right path"],"answer":1,"hint":"Look where the blockage is","explanation":"The right path leads to the bucket.","voice":"Which pipe will fill the bucket, left or right?"},
    {"prompt":"Which melts faster: ice in the sun or ice in the shade?","options":["Sun","Shade"],"answer":0,"hint":"Where is it warmer?","explanation":"Ice melts faster in the sun because it is warmer.","voice":"Which melts faster, ice in the sun or ice in the shade?"},
    {"prompt":"Which object will make a bigger shadow under the same light?","options":["Tall tree","Small plant","Feather"],"answer":0,"hint":"Bigger objects cast bigger shadows","explanation":"A tall tree casts a larger shadow.","voice":"Which object makes a bigger shadow under the same light?"},
    {"prompt":"What color do you get when you mix red and blue?","options":["Purple","Green","Orange"],"answer":0,"hint":"Red plus blue","explanation":"Red and blue make purple.","voice":"What color results when you mix red and blue?"},
    {"prompt":"Which animal lives in water?","options":["Fish","Dog","Bird"],"answer":0,"hint":"Breathes underwater","explanation":"Fish live in water and have gills.","voice":"Which animal lives in water?"},
    {"prompt":"Which object will stick to a magnet?","options":["Paper clip","Balloon","Cork"],"answer":0,"hint":"Look for metal","explanation":"A paper clip is made of metal and sticks to a magnet.","voice":"Which object will stick to a magnet?"},
    {"prompt":"Which does a plant need to grow?","options":["Sunlight","Candy","Video games"],"answer":0,"hint":"Plants get energy from the sun","explanation":"Plants need sunlight, water and soil to grow.","voice":"Which does a plant need to grow?"},
    {"prompt":"Which is a push action?","options":["Opening a door by pulling","Kicking a ball","Picking up a cup"],"answer":1,"hint":"Pushing moves something away from you","explanation":"Kicking a ball is a push action.","voice":"Which is a push action?"},
    {"prompt":"Which will float: a sealed plastic bottle or a heavy metal spoon?","options":["Plastic bottle","Metal spoon","Both"],"answer":0,"hint":"Think about trapped air","explanation":"A sealed plastic bottle traps air and floats.","voice":"Which will float: a sealed plastic bottle or a metal spoon?"},
    {"prompt":"Which material is used to make a shadow puppet?","options":["Paper","Glass","Water"],"answer":0,"hint":"Must block light and be easy to cut","explanation":"Paper is used for shadow puppets.","voice":"Which material is used to make a shadow puppet?"},
    {"prompt":"Which object is magnetic?","options":["Wooden spoon","Iron key","Plastic toy"],"answer":1,"hint":"Made of iron or steel","explanation":"An iron key is magnetic.","voice":"Which object is magnetic?"},
    {"prompt":"Which will sink in water?","options":["Stone","Cork","Soap"],"answer":0,"hint":"Heavy and dense objects sink","explanation":"A stone is denser than water and will sink.","voice":"Which will sink in water?"},
    {"prompt":"What does a thermometer measure?","options":["Temperature","Speed","Color"],"answer":0,"hint":"Use to check a fever","explanation":"A thermometer measures temperature.","voice":"What does a thermometer measure?"},
    {"prompt":"Which helps a boat float more: more weight or larger surface area?","options":["More weight","Larger surface area","Softer material"],"answer":1,"hint":"Spreading weight helps","explanation":"A larger surface area helps buoyancy and makes floating easier.","voice":"Which helps a boat float more: more weight or larger surface area?"},
    {"prompt":"Which object will roll easily?","options":["Ball","Block","Sheet of paper"],"answer":0,"hint":"Round objects roll","explanation":"A ball is round and rolls easily.","voice":"Which object will roll easily?"},
    {"prompt":"Which season do leaves usually fall?","options":["Autumn","Summer","Spring"],"answer":0,"hint":"When trees prepare for winter","explanation":"Leaves commonly fall during autumn.","voice":"Which season do leaves usually fall?"},
    {"prompt":"Which light source is the hottest?","options":["Sun","Candle","Lamp"],"answer":0,"hint":"What keeps us warm in the day","explanation":"The Sun has a much higher temperature than a candle or lamp.","voice":"Which light source is the hottest?"},
    {"prompt":"Which will fill with air when you blow into it?","options":["Balloon","Stone","Cup"],"answer":0,"hint":"It inflates when you blow","explanation":"A balloon fills with air when you blow into it.","voice":"Which will fill with air when you blow into it?"}
  ],
  "8-14": [
    {"prompt":"Which simple circuit will light the bulb?","options":["Battery + Wire + Bulb (complete loop)","Battery + Bulb (no wire)","Wire + Bulb (no battery)"],"answer":0,"hint":"Need a power source and a complete loop","explanation":"A battery and a closed loop of wire allow current to flow and light the bulb.","voice":"Which simple circuit will light the bulb?"},
    {"prompt":"Which is a lever that makes lifting easier?","options":["Long stick under a rock (fulcrum near rock)","Short stick directly under rock","No stick"],"answer":0,"hint":"Longer arm reduces force needed","explanation":"A longer lever arm reduces the force required to lift.","voice":"Which lever makes lifting easier?"},
    {"prompt":"Which material transmits sound fastest?","options":["Air","Water","Steel"],"answer":2,"hint":"Sound travels faster in solids than in liquids or gases","explanation":"Sound travels fastest in steel among these options.","voice":"Which material transmits sound fastest?"},
    {"prompt":"Which shape has the least air resistance when falling?","options":["Flat sheet","Streamlined object","Parachute"],"answer":1,"hint":"Designed to reduce drag","explanation":"A streamlined object has less air resistance.","voice":"Which shape has the least air resistance when falling?"},
    {"prompt":"Which option shows potential energy converting to kinetic energy?","options":["Ball at top rolling down","Ball at rest on table","Ball pushed and held"],"answer":0,"hint":"Energy changes when it moves downhill","explanation":"A ball rolling down converts potential energy to kinetic energy.","voice":"Which option shows potential energy converting to kinetic energy?"},
    {"prompt":"Which liquid will evaporate fastest at room temperature?","options":["Water","Honey","Vegetable oil"],"answer":0,"hint":"Less viscous liquids evaporate quicker","explanation":"Water evaporates faster than syrupy liquids like honey.","voice":"Which liquid evaporates fastest at room temperature?"},
    {"prompt":"Which lens makes distant objects appear smaller?","options":["Convex","Concave","Plano"],"answer":1,"hint":"Diverging lens makes images smaller","explanation":"A concave lens diverges light and makes images appear smaller.","voice":"Which lens makes distant objects appear smaller?"},
    {"prompt":"Which soil type drains water fastest?","options":["Sand","Clay","Loam"],"answer":0,"hint":"Large grain size drains quickly","explanation":"Sand drains water faster than clay or loam.","voice":"Which soil type drains water fastest?"},
    {"prompt":"Which produces static electricity?","options":["Rubbing balloon on hair","Putting balloon in water","Freezing balloon"],"answer":0,"hint":"Friction transfers electrons","explanation":"Rubbing a balloon on hair transfers charge and produces static electricity.","voice":"Which action produces static electricity?"},
    {"prompt":"Why does a metal spoon get hot in hot soup?","options":["Conduction","Convection","Radiation"],"answer":0,"hint":"Heat travels through contact","explanation":"Heat moves along the metal by conduction.","voice":"Why does a metal spoon get hot in hot soup?"},
    {"prompt":"Which is an example of chemical change?","options":["Paper burning","Ice melting","Salt dissolving"],"answer":0,"hint":"New substances are formed","explanation":"Burning paper forms ash and gases (chemical change).","voice":"Which is an example of a chemical change?"},
    {"prompt":"What does pH measure?","options":["Acidity or basicity","Temperature","Density"],"answer":0,"hint":"Used for acids and bases","explanation":"pH measures how acidic or basic a solution is.","voice":"What does pH measure?"},
    {"prompt":"Which device measures electrical current?","options":["Ammeter","Thermometer","Barometer"],"answer":0,"hint":"Think amps","explanation":"An ammeter measures electrical current in amperes.","voice":"Which device measures electrical current?"},
    {"prompt":"Which structure carries oxygen in blood?","options":["Red blood cells","White blood cells","Platelets"],"answer":0,"hint":"Contains hemoglobin","explanation":"Red blood cells carry oxygen using hemoglobin.","voice":"Which structure carries oxygen in blood?"},
    {"prompt":"Which best explains why oil floats on water?","options":["Oil is less dense than water","Oil is more dense than water","They mix evenly"],"answer":0,"hint":"Which liquid sits on the other?","explanation":"Oil floats because it is less dense than water.","voice":"Which best explains why oil floats on water?"},
    {"prompt":"Which instrument measures atmospheric pressure?","options":["Barometer","Hygrometer","Anemometer"],"answer":0,"hint":"Used in weather forecasting","explanation":"A barometer measures air pressure.","voice":"Which instrument measures atmospheric pressure?"},
    {"prompt":"Which form of energy is stored in food?","options":["Chemical energy","Nuclear energy","Light energy"],"answer":0,"hint":"Released when we digest food","explanation":"Food stores chemical energy.","voice":"Which form of energy is stored in food?"}
  ],
  "14+": [
    {"prompt":"Which circuit configuration will cause a short circuit?","options":["Battery terminals connected directly by a wire","Resistor in series with lamp","Proper circuit with switch"],"answer":0,"hint":"Bypasses the load","explanation":"Directly connecting terminals causes a short and a large current.","voice":"Which configuration causes a short circuit?"},
    {"prompt":"Which scenario best describes the greenhouse effect?","options":["Earth traps heat from the Sun due to greenhouse gases","Sun getting closer to Earth","More clouds always cool the planet"],"answer":0,"hint":"Gases trap infrared radiation","explanation":"Greenhouse gases trap outgoing heat and warm the planet.","voice":"Which scenario best describes the greenhouse effect?"},
    {"prompt":"Which optical phenomenon bends light at an interface?","options":["Refraction","Reflection","Diffraction"],"answer":0,"hint":"Light changes direction between media","explanation":"Refraction is the bending of light when it passes between different media.","voice":"Which phenomenon bends light at an interface?"},
    {"prompt":"Which formula represents conservation of mechanical energy?","options":["KE_initial + PE_initial = KE_final + PE_final","Force = mass √ó acceleration","Pressure = force / area"],"answer":0,"hint":"Total mechanical energy (without losses) stays the same","explanation":"Kinetic plus potential energy remains constant if non-conservative forces are absent.","voice":"Which formula represents conservation of mechanical energy?"},
    {"prompt":"Which gas contributes to acid rain?","options":["Sulfur dioxide","Nitrogen gas","Oxygen"],"answer":0,"hint":"Emitted by burning fossil fuels","explanation":"Sulfur dioxide forms acidic compounds in the atmosphere leading to acid rain.","voice":"Which gas contributes to acid rain?"},
    {"prompt":"Which best describes an exothermic reaction?","options":["Releases heat","Absorbs heat","No temperature change"],"answer":0,"hint":"Surroundings get warmer","explanation":"Exothermic reactions release heat to the surroundings.","voice":"Which best describes an exothermic reaction?"},
    {"prompt":"Which biomolecule stores genetic information?","options":["DNA","Carbohydrate","Lipid"],"answer":0,"hint":"Found in cell nuclei","explanation":"DNA stores hereditary information in cells.","voice":"Which biomolecule stores genetic information?"},
    {"prompt":"Which method is best for separating a soluble solid from a liquid?","options":["Evaporation","Filtration","Magnetic separation"],"answer":0,"hint":"Remove the liquid to get the solid back","explanation":"Evaporation leaves the dissolved solid behind.","voice":"Which method separates a soluble solid from a liquid?"},
    {"prompt":"Why do metals conduct electricity?","options":["Free electrons move through the lattice","Ionic bonds break","They contain water"],"answer":0,"hint":"Free charges that move","explanation":"Metals have delocalized electrons which carry electric current.","voice":"Why do metals conduct electricity?"},
    {"prompt":"Which process produces biodegradation?","options":["Microbial activity","Burning","Plastics"],"answer":0,"hint":"Living organisms break organic matter down","explanation":"Microorganisms decompose organic waste.","voice":"Which process produces biodegradation?"},
    {"prompt":"Which unit measures electric charge?","options":["Coulomb","Watt","Newton"],"answer":0,"hint":"Symbol is C","explanation":"Electric charge is measured in coulombs.","voice":"Which unit measures electric charge?"},
    {"prompt":"Which describes nuclear fusion?","options":["Combining light nuclei to form heavier ones","Splitting heavy nuclei","Chemical bonding"],"answer":0,"hint":"What powers the Sun","explanation":"Nuclear fusion combines light nuclei producing large energy.","voice":"Which describes nuclear fusion?"},
    {"prompt":"Which law states F = ma?","options":["Newton's Second Law","Law of Conservation of Energy","Ohm's Law"],"answer":0,"hint":"Force equals mass times acceleration","explanation":"Newton's second law states that force equals mass times acceleration.","voice":"Which law states F equals ma?"},
    {"prompt":"Which process forms sedimentary rocks?","options":["Compaction and cementation of sediments","Melting and cooling","Metamorphism"],"answer":0,"hint":"Layers build up over time","explanation":"Sediments compact and cement to become sedimentary rocks.","voice":"Which process forms sedimentary rocks?"},
    {"prompt":"Which property does not change during a physical change?","options":["Chemical composition","Shape","Phase"],"answer":0,"hint":"Identity remains the same","explanation":"Chemical composition remains unchanged during physical changes.","voice":"Which property does not change during a physical change?"},
    {"prompt":"Which process regulates blood glucose in humans?","options":["Insulin and glucagon hormones","Photosynthesis","Respiration only"],"answer":0,"hint":"Hormones from the pancreas","explanation":"Insulin and glucagon regulate blood glucose levels.","voice":"Which process regulates blood glucose in humans?"}
  ]
};

/* ============================
   State & helpers
   ============================ */
const storagePrefix = 'scigame_v1_';
let currentAge = null;
let currentIndex = 0;
let currentMode = 'play';
let progress = { points:0, stars:0, solved:{} };
let currentExperiment = null;

function $(id){ return document.getElementById(id); }
function escapeHtml(s){ return (''+s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":\"&#39;\"}[c] || c)); }

function speak(text){
  if(!('speechSynthesis' in window)) return;
  try{ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.speak(u); } catch(e){}
}

/* Select age (inline onclick) */
function selectAge(age, el){
  currentAge = age;
  currentIndex = 0;
  progress = loadProgress(age);
  $('stage-age').style.display = 'none';
  $('stage-hub').style.display = 'block';
  $('hub-title').textContent = 'Age ' + age;
  updateProgressUI();
  setMode('play');
  showExperiment();
  // visual pressed
  document.querySelectorAll('.tile').forEach(t => t.setAttribute('aria-pressed','false'));
  if(el) el.setAttribute('aria-pressed','true');
}

/* Back to age selection */
function backToAge(){
  try{ window.speechSynthesis && window.speechSynthesis.cancel(); }catch(e){}
  currentAge = null;
  $('stage-hub').style.display = 'none';
  $('stage-age').style.display = 'block';
}

/* Storage */
function storageKey(age){ return storagePrefix + age; }
function loadProgress(age){
  const raw = localStorage.getItem(storageKey(age));
  if(!raw) return { points:0, stars:0, solved:{} };
  try{ return JSON.parse(raw); } catch(e){ return { points:0, stars:0, solved:{} }; }
}
function saveProgress(){
  if(!currentAge) return;
  localStorage.setItem(storageKey(currentAge), JSON.stringify(progress));
  updateProgressUI();
}

/* Update UI numbers */
function updateProgressUI(){
  if(!currentAge) return;
  const total = (EXPERIMENTS[currentAge] || []).length;
  const solvedCount = Object.keys(progress.solved || {}).length;
  $('progress-display').textContent = `Solved ${solvedCount} / ${total}`;
  $('pts').textContent = progress.points || 0;
  $('stars').textContent = progress.stars || 0;
}

/* Set mode */
function setMode(m){
  currentMode = (m === 'train') ? 'train' : 'play';
  $('btn-play').style.fontWeight = currentMode === 'play' ? '800' : '400';
  $('btn-train').style.fontWeight = currentMode === 'train' ? '800' : '400';
  if(currentAge) showExperiment();
}

/* Show single experiment */
function showExperiment(){
  const list = EXPERIMENTS[currentAge] || [];
  if(currentIndex >= list.length){
    $('experiment-card').style.display = 'none';
    $('finished-card').style.display = 'block';
    return;
  }
  $('finished-card').style.display = 'none';
  $('experiment-card').style.display = 'block';
  currentExperiment = list[currentIndex];
  $('question-text').textContent = `(${currentIndex+1}) ${currentExperiment.prompt}`;

  // render options
  const box = $('options-box'); box.innerHTML = '';
  currentExperiment.options.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'opt-btn';
    btn.textContent = opt;
    btn.onclick = ()=> handleChoice(i);
    if(currentMode === 'train' && i === currentExperiment.answer){
      btn.style.border = '2px solid #9fd';
    }
    box.appendChild(btn);
  });

  $('feedback').innerHTML = '';
  $('next-btn').style.display = 'none';
  // speak
  speak(currentExperiment.voice || currentExperiment.prompt);
}

/* Handle choice */
function handleChoice(i){
  if(currentMode === 'train'){
    showTrainingAnswer();
    return;
  }
  const fb = $('feedback');
  currentExperiment.tries = (currentExperiment.tries || 0) + 1;
  if(i === currentExperiment.answer){
    fb.innerHTML = `<div class="correct">‚úÖ Correct! ${escapeHtml(currentExperiment.explanation)}</div>`;
    speak('Correct! Well done.');
    awardPoints();
    $('next-btn').style.display = 'inline-block';
  } else {
    fb.innerHTML = `<div class="wrong">‚ùå Wrong. Try again.</div>`;
    speak('Wrong. Try again.');
  }
}

/* Training answer */
function showTrainingAnswer(){
  const fb = $('feedback');
  const answerText = currentExperiment.options[currentExperiment.answer];
  fb.innerHTML = `<div class="correct">Answer: ${escapeHtml(answerText)}. ${escapeHtml(currentExperiment.explanation)}</div>`;
  speak((currentExperiment.voice || currentExperiment.prompt) + '. Answer: ' + answerText + '. ' + currentExperiment.explanation);
  $('next-btn').style.display = 'inline-block';
}

/* Award points (only once per experiment) */
function awardPoints(){
  const key = 'exp_'+currentIndex;
  if(progress.solved && progress.solved[key]) return;
  let pts = 0;
  if(currentExperiment.tries === 1) pts = 10;
  else pts = 4;
  progress.points = (progress.points || 0) + pts;
  progress.stars = (progress.stars || 0) + 1;
  progress.solved[key] = Date.now();
  saveProgress();
}

/* Next experiment */
function nextExperiment(){
  currentIndex++;
  showExperiment();
}

/* Hint & repeat */
function showHint(){
  if(!currentExperiment) return;
  $('feedback').innerHTML = `<div class="hint">Hint: ${escapeHtml(currentExperiment.hint)}</div>`;
  speak('Hint: ' + currentExperiment.hint);
}
function repeatVoice(){
  if(!currentExperiment) return;
  speak(currentExperiment.voice || currentExperiment.prompt);
}

/* Restart level */
function restartLevel(){
  currentIndex = 0;
  showExperiment();
}

/* Printable certificate page */
function openPrintableCertificate(){
  if(!currentAge) return alert('Please choose an age group first.');
  const name = prompt('Enter name for the certificate:', localStorage.getItem('scigame_player_name') || '');
  if(!name) return;
  localStorage.setItem('scigame_player_name', name);

  const solved = Object.keys(progress.solved || {}).length;
  const total = (EXPERIMENTS[currentAge] || []).length;
  const points = progress.points || 0;
  const badge = (progress.stars >= 60) ? 'Gold' : (progress.stars >= 30 ? 'Silver' : (progress.stars >= 10 ? 'Bronze' : 'None'));

  const html = `
    <!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Certificate</title>
    <style>body{font-family:serif;padding:28px;text-align:center} .title{font-family:cursive;font-size:56px} .small{font-size:16px;color:#333}</style>
    </head><body>
      <div class="title">Certificate</div>
      <div style="margin-top:8px;font-size:20px">Science Experiment Games</div>
      <div style="margin-top:30px">This certifies that</div>
      <div style="margin-top:12px;font-size:28px;font-weight:700">${escapeHtml(name)}</div>
      <div style="margin-top:18px" class="small">has completed <strong>${solved}</strong> out of <strong>${total}</strong> experiments in Age <strong>${currentAge}</strong>, scoring <strong>${points}</strong> points.</div>
      <div style="margin-top:24px" class="small">Badge: ${escapeHtml(badge)}</div>
      <div style="position:fixed;bottom:18px;width:100%;text-align:center;font-size:12px;color:#444">Created &amp; Designed by Animesh</div>
      <script>setTimeout(()=>{ if(confirm('Open print dialog? (Use Save as PDF to save certificate)')) window.print(); },350);</script>
    </body></html>
  `;
  const w = window.open('', '_blank');
  if(!w) return alert('Popup blocked ‚Äî allow popups for this site to open certificate.');
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* Initialize */
document.addEventListener('DOMContentLoaded', ()=>{
  // nothing heavy on load; waits for user selection
});
</script>
</body>
</html>
